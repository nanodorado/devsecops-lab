#!/bin/bash

# recon_nmap.sh - Professional Nmap reconnaissance script
# Usage: ./recon_nmap.sh <target> [output_dir]
# Example: ./recon_nmap.sh 192.168.1.10 scans/

set -e

TARGET="$1"
OUTPUT_DIR="${2:-nmap_reports}"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BASENAME="${OUTPUT_DIR}/scan_${TARGET//./_}_${TIMESTAMP}"

# Validate input
if [ -z "$TARGET" ]; then
  echo "Usage: $0 <target IP or hostname> [output_dir]"
  exit 1
fi

# Create output directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"

echo "üîç Starting Nmap reconnaissance on: $TARGET"
echo "üìÅ Output directory: $OUTPUT_DIR"

# Perform initial TCP SYN scan of top 1000 ports
echo "üì° Running top 1000 port scan..."
nmap -sS -T4 -Pn --top-ports 1000 -oA "${BASENAME}_top1000" "$TARGET"

# Perform service version detection
echo "üß† Running service version detection..."
nmap -sV -T4 -Pn -p- --min-rate=1000 --max-retries=3 -oA "${BASENAME}_full" "$TARGET"

# Optional: OS detection and script scan (slower)
echo "üõ°Ô∏è Running OS detection and vulnerability scan..."
nmap -A -T4 -Pn --script vuln -oA "${BASENAME}_vuln" "$TARGET"

echo "‚úÖ Scan complete."
echo "üìù Reports saved as:"
echo " - ${BASENAME}_top1000.*"
echo " - ${BASENAME}_full.*"
echo " - ${BASENAME}_vuln.*"